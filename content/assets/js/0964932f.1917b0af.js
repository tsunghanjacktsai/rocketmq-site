"use strict";(self.webpackChunkrocketmq_docs=self.webpackChunkrocketmq_docs||[]).push([[7424],{15680:(e,t,s)=>{s.d(t,{xA:()=>c,yg:()=>p});var a=s(96540);function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function i(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,a)}return s}function r(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?i(Object(s),!0).forEach((function(t){n(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):i(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function o(e,t){if(null==e)return{};var s,a,n=function(e,t){if(null==e)return{};var s,a,n={},i=Object.keys(e);for(a=0;a<i.length;a++)s=i[a],t.indexOf(s)>=0||(n[s]=e[s]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)s=i[a],t.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(n[s]=e[s])}return n}var l=a.createContext({}),m=function(e){var t=a.useContext(l),s=t;return e&&(s="function"==typeof e?e(t):r(r({},t),e)),s},c=function(e){var t=m(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var s=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=m(s),u=n,p=d["".concat(l,".").concat(u)]||d[u]||g[u]||i;return s?a.createElement(p,r(r({ref:t},c),{},{components:s})):a.createElement(p,r({ref:t},c))}));function p(e,t){var s=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=s.length,r=new Array(i);r[0]=u;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[d]="string"==typeof e?e:n,r[1]=o;for(var m=2;m<i;m++)r[m]=s[m];return a.createElement.apply(null,r)}return a.createElement.apply(null,s)}u.displayName="MDXCreateElement"},47465:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>g,frontMatter:()=>i,metadata:()=>o,toc:()=>m});var a=s(58168),n=(s(96540),s(15680));const i={},r="Delay Message",o={unversionedId:"featureBehavior/02delaymessage",id:"version-5.0/featureBehavior/02delaymessage",title:"Delay Message",description:"Delay messages are messages with advanced features in Apache RocketMQ. This topic describes the scenarios, working mechanism, limits, usage examples, and usage notes of delay messages and delayed messages.",source:"@site/i18n/en/docusaurus-plugin-content-docs/version-5.0/04-featureBehavior/02delaymessage.md",sourceDirName:"04-featureBehavior",slug:"/featureBehavior/02delaymessage",permalink:"/docs/featureBehavior/02delaymessage",draft:!1,editUrl:"https://github.com/apache/rocketmq-site/tree/new-official-website/versioned_docs/version-5.0/04-featureBehavior/02delaymessage.md",tags:[],version:"5.0",frontMatter:{},sidebar:"version-5.0/myAutogeneratedSidebar",previous:{title:"Normal Message",permalink:"/docs/featureBehavior/01normalmessage"},next:{title:"Ordered Message",permalink:"/docs/featureBehavior/03fifomessage"}},l={},m=[{value:"Scenarios",id:"scenarios",level:2},{value:"Working mechanism",id:"working-mechanism",level:2},{value:"Usage limits",id:"usage-limits",level:2},{value:"Example",id:"example",level:2},{value:"Usage notes",id:"usage-notes",level:2}],c={toc:m},d="wrapper";function g(e){let{components:t,...i}=e;return(0,n.yg)(d,(0,a.A)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("h1",{id:"delay-message"},"Delay Message"),(0,n.yg)("p",null,"Delay messages are messages with advanced features in Apache RocketMQ. This topic describes the scenarios, working mechanism, limits, usage examples, and usage notes of delay messages and delayed messages."),(0,n.yg)("admonition",{type:"note"},(0,n.yg)("p",{parentName:"admonition"},"Scheduled message and delay message are essentially the same. Both of them deliver messages to consumers at a fixed time according to the timing time set by the message. Therefore, delay messages are used in the following sections.")),(0,n.yg)("h2",{id:"scenarios"},"Scenarios"),(0,n.yg)("p",null,"Accurate and reliable time-based event triggers are required in scenarios such as distributed timed scheduling and task timeout processing. Apache RocketMQ provides delay messages to help you simplify the development of timed scheduling tasks and implement high-performance, scalable, and reliable timed triggering."),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Scenario 1: Distributed timed scheduling"),"\n",(0,n.yg)("img",{alt:"\u5b9a\u65f6\u6d88\u606f",src:s(73681).A,width:"906",height:"546"})),(0,n.yg)("p",null,"A distributed timed scheduling scenario involves tasks that require various time granularity levels, for example, a task to execute file cleanup at 5 o'clock every day or a task to trigger push messages every 2 minutes. Traditional dataset-based timed scheduling solutions are complex and inefficient in distributed scenarios. In comparison, delay messages in Apache RocketMQ allow you to encapsulate multiple types of time triggers."),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Scenario 2: Task timeout processing"),"\n",(0,n.yg)("img",{alt:"\u8d85\u65f6\u4efb\u52a1\u5904\u7406",src:s(84563).A,width:"954",height:"429"})),(0,n.yg)("p",null,"A typical scenario that involves task timeout processing is e-commerce payment, where an unpaid order is canceled after it remains unpaid for a specific time period instead of being canceled immediately. In this case, you can use delay messages in Apache RocketMQ to check and trigger timeout tasks."),(0,n.yg)("p",null,"Task timeout processing based on delay messages provides the following benefits:"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Various time granularity levels and simplified development: Scheduled messaging in Apache RocketMQ does not have the limit of fixed time increments. You can trigger tasks at any time granularity level and without deduplication.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"High performance and scalability: delay messages in Apache RocketMQ offer high concurrency and scalability. This outperforms traditional database scanning methods, which are complex to implement and can cause performance bottlenecks due to frequent API calls for scanning."))),(0,n.yg)("h2",{id:"working-mechanism"},"Working mechanism"),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Definition of delay messages")),(0,n.yg)("p",null,"delay messages are messages with advanced features in Apache RocketMQ. delay messages allow consumers to consume messages that are sent to the server only after a specified period of time or at a specified time. You can use delay messages to implement delayed scheduling and triggering in distributed scenarios."),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Time setting rules")),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"The scheduled or delayed time for delay messages in Apache RocketMQ is represented as a timestamp, not a time period.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"The scheduled time is in the format of a millisecond-level Unix timestamp. You must convert the scheduled time of message delivery to a millisecond-level Unix timestamp. You can use the ",(0,n.yg)("a",{parentName:"p",href:"https://www.unixtimestamp.com/"},"Unix timestamp converter")," to convert a time to a millisecond-level Unix timestamp.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"The scheduled time must be within the allowed time range. If the scheduled time exceeds the range, the scheduled time does not take effect and the messages are immediately delivered from the server side.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"By default, the maximum time range for delay messages is 24 hours. You cannot change the default value. For more information, see",(0,n.yg)("a",{parentName:"p",href:"/docs/introduction/03limits"},"Parameter limits"),".")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"The scheduled time must be later than the current time. If the scheduled time is set to a time earlier than the current time, the scheduled time does not take effect and the messages are immediately delivered from the server side."))),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"The following section provides two time setting examples:")),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"delay messages: If the current time is 2022-06-09 17:30:00 and you want to deliver messages at 2022-06-09 19:20:00, the millisecond-level Unix timestamp of the scheduled time is 1654773600000.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Delayed messages: If the current time is 2022-06-09 17:30:00 and you want to deliver messages after 1 hour, the message delivery time is 2022-06-09 18:30:00 and the millisecond-level Unix timestamp is 1654770600000."))),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Lifecycle of a scheduled message")),(0,n.yg)("p",null,(0,n.yg)("img",{alt:"\u5b9a\u65f6\u6d88\u606f\u751f\u547d\u5468\u671f",src:s(70937).A,width:"1181",height:"110"})),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Initialized: The message is built and initialized by the producer and is ready to be sent to the server.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Timing: The message is sent to the server side, where the message is stored in a time-based storage system until the specified delivery time. An index is not immediately created for the message.")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Ready: At the specified time, the message is written into a regular storage engine, where the message is visible for consumers and waits for consumption by consumers."))),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Inflight: The message is obtained by the consumer and processed based on the local business logic of the consumer."),(0,n.yg)("p",{parentName:"li"},"In this process, the broker waits for the consumer to complete the consumption and submit the consumption result. If no response is received from the consumer in a certain period of time, Apache RocketMQ retries the message. For more information, see ",(0,n.yg)("a",{parentName:"p",href:"/docs/featureBehavior/10consumerretrypolicy"},"Consumption retry"),"."))),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("p",{parentName:"li"},"Acked: The consumer completes consumption and submits the consumption result to the broker. The broker marks whether the current message is successfully consumed."),(0,n.yg)("p",{parentName:"li"},"By default, Apache RocketMQ retains all messages. When the consumption result is submitted, the message data is logically marked as consumed instead of being deleted immediately. Therefore, the consumer can backtrack the message for re-consumption before it is deleted due to the expiration of the retention period or insufficient storage space."))),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},"Deleted: When the retention period of the message expires or the storage space is insufficient, Apache RocketMQ deletes the earliest saved message from the physical file in a rolling manner. For more information, see ",(0,n.yg)("a",{parentName:"li",href:"/docs/featureBehavior/11messagestorepolicy"},"Message storage and cleanup"),".")),(0,n.yg)("h2",{id:"usage-limits"},"Usage limits"),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Message type consistency")),(0,n.yg)("p",null,"delay messages can be sent only to topics whose MessageType is Delay."),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Time granularity")),(0,n.yg)("p",null,"The time granularity for delay messages in Apache RocketMQ is down to milliseconds. The default granularity value is 1000 ms."),(0,n.yg)("p",null,"The status of delay messages in Apache RocketMQ can be persistently stored. If the messaging system experiences a failure and is restarted, messages are still delivered based on the specified delivery time. However, if the storage system experiences an exception or is restarted, latency may occur in delivering delay messages."),(0,n.yg)("h2",{id:"example"},"Example"),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Create topic")),(0,n.yg)("p",null,"For creating topics in Apache RocketMQ 5.0, it is recommended to use the mqadmin tool. However, it is worth noting that message type needs to be added as a property parameter. Here is an example:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-shell"},"sh mqadmin updateTopic -n <nameserver_address> -t <topic_name> -c <cluster_name> -a +message.type=Delay\n")),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Send messages")),(0,n.yg)("p",null,"Unlike normal messages, delay messages must have a delivery timestamp specified for them."),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"Create DELAY Topic")),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"/bin/mqadmin updateTopic -c DefaultCluster -t DelayTopic -n 127.0.0.1:9876 -a +message.type=DELAY\n")),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},"-c the cluster name"),(0,n.yg)("li",{parentName:"ul"},"-t the topic name"),(0,n.yg)("li",{parentName:"ul"},"-n the address of the nameserver"),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("strong",{parentName:"li"},"-a extra attributes\uff0cwe add an ",(0,n.yg)("inlineCode",{parentName:"strong"},"message.type")," attribute with value ",(0,n.yg)("inlineCode",{parentName:"strong"},"DELAY")," to support delivery DELAY message."))),(0,n.yg)("p",null,"The following code provides Java examples of delivery and consumption of delay messages:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-java"},'        // Send delay messages.\n        MessageBuilder messageBuilder = null;\n        // Specify a millisecond-level Unix timestamp. In this example, the specified timestamp indicates that the message will be delivered in 10 minutes from the current time. \n        Long deliverTimeStamp = System.currentTimeMillis() + 10L * 60 * 1000;\n        Message message = messageBuilder.setTopic("topic")\n                // Specify the message index key. The system uses the key to locate the message. \n                .setKeys("messageKey")\n                // Specify the message tag. The consumer can use the tag to filter messages. \n                .setTag("messageTag")\n                .setDeliveryTimestamp(deliverTimeStamp)\n                // Configure the message body.\n                .setBody("messageBody".getBytes())\n                .build();\n        try {\n            // Send the messages. Focus on the result of message sending and exceptions such as failures. \n            SendReceipt sendReceipt = producer.send(message);\n            System.out.println(sendReceipt.getMessageId());\n        } catch (ClientException e) {\n            e.printStackTrace();\n        }\n        // Consumption example 1: If a scheduled message is consumed by a push consumer, the consumer needs to process the message only in the message listener. \n        MessageListener messageListener = new MessageListener() {\n            @Override\n            public ConsumeResult consume(MessageView messageView) {\n                System.out.println(messageView.getDeliveryTimestamp());\n                // Return the status based on the consumption result. \n                return ConsumeResult.SUCCESS;\n            }\n        };\n        // Consumption example 2: If a scheduled message is consumed by a simple consumer, the consumer must obtain the message for consumption and submit the consumption result. \n        List<MessageView> messageViewList = null;\n        try {\n            messageViewList = simpleConsumer.receive(10, Duration.ofSeconds(30));\n            messageViewList.forEach(messageView -> {\n                System.out.println(messageView);\n                // After consumption is complete, the consumer must invoke ACK to submit the consumption result. \n                try {\n                    simpleConsumer.ack(messageView);\n                } catch (ClientException e) {\n                    e.printStackTrace();\n                }\n            });\n        } catch (ClientException e) {\n            // If the pull fails due to system traffic throttling or other reasons, you must re-initiate the request to obtain the message. \n            e.printStackTrace();\n        }\n    }\n')),(0,n.yg)("h2",{id:"usage-notes"},"Usage notes"),(0,n.yg)("p",null,(0,n.yg)("strong",{parentName:"p"},"We recommend that you do not schedule the same delivery time for a large number of messages.")),(0,n.yg)("p",null,"delay messages are stored in a time-based storage system before they are delivered to consumers at the specified delivery time. If you specify the same delivery time for a large number of delay messages, the system has to simultaneously process the messages at the delivery time. This puts the system under heavy load and results in delays in message delivery."))}g.isMDXComponent=!0},73681:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/delaywork-e9647b539ae35898102a336a27d3ad94.png"},70937:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/lifecyclefordelay-2ce8278df69cd026dd11ffd27ab09a17.png"},84563:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/scheduletask-1944aea7bf2a4a4c56be4d90ead4f1f3.png"}}]);